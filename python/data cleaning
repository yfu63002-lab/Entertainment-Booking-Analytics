import pandas as pd

# ---------- 1. Load data ----------

agents = pd.read_csv("/agents.csv")
customers = pd.read_csv("/customers.csv")
entertainers = pd.read_csv("/entertainers.csv")
members = pd.read_csv("/members.csv")
engagements = pd.read_csv("/engagements.csv")
entertainer_styles = pd.read_csv("/entertainer_styles.csv")
entertainer_members = pd.read_csv("/entertainer_members.csv")
musical_styles = pd.read_csv("/musical_styles.csv")
musical_preferences = pd.read_csv("/musical_preferences.csv")

tables = {
    "agents": agents,
    "customers": customers,
    "entertainers": entertainers,
    "members": members,
    "engagements": engagements,
    "entertainer_styles": entertainer_styles,
    "entertainer_members": entertainer_members,
    "musical_styles": musical_styles,
    "musical_preferences": musical_preferences,
}

# ---------- 2. Missing value checks ----------

print("=== Missing value summary for each table ===")
for name, df in tables.items():
    print(f"\n{name}")
    print(df.isna().sum())


# ---------- 3. Duplicate checks ----------

print("\n=== Duplicate row checks ===")
for name, df in tables.items():
    dup_count = df.duplicated().sum()
    print(f"{name}: {dup_count} fully duplicated rows")

# Check composite keys for relationship tables (use lowercase column names)

print("\nEntertainer_Styles duplicated (entertainerid, styleid):",
      entertainer_styles.duplicated(subset=["entertainerid", "styleid"]).sum())

print("Entertainer_Members duplicated (entertainerid, memberid):",
      entertainer_members.duplicated(subset=["entertainerid", "memberid"]).sum())

print("Musical_Preferences duplicated (customerid, styleid, preferenceseq):",
      musical_preferences.duplicated(subset=["customerid", "styleid", "preferenceseq"]).sum())



# ---------- 4. Basic outlier / invalid value checks ----------

# 4.1 Agent salary & commission rate

print("\n=== Agents: salary summary ===")
print(agents["salary"].describe())

suspicious_salary = agents[
    (agents["salary"] < 0) | (agents["salary"] < 1000) | (agents["salary"] > 100000)
]
print("\nAgents with suspicious salaries (possible outliers):")
print(suspicious_salary)

print("\n=== Agents: commission rate outside [0, 1] ===")
print(agents[(agents["commissionrate"] < 0) | (agents["commissionrate"] > 1)])


# 4.2 contractprice in engagements (lowercase column name)
print("\n=== Engagements: contractprice summary ===")
print(engagements["contractprice"].describe())

print("\nEngagements with non-positive contractprice:")
print(engagements[engagements["contractprice"] <= 0])


# 4.3 StyleStrength & PreferenceSeq
print("\nEntertainer_Styles with stylestrength outside [1, 10]:")
print(entertainer_styles[(entertainer_styles["stylestrength"] < 1) |
                         (entertainer_styles["stylestrength"] > 10)])

print("\nMusical_Preferences with PreferenceSeq <= 0:")
print(musical_preferences[musical_preferences["preferenceseq"] <= 0])



# ---------- 5. Referential integrity checks (foreign keys, use lowercase) ----------

# Engagements → Customers
eng_cust = engagements.merge(
    customers[["customerid"]],
    on="customerid",
    how="left",
    indicator=True
)
print("\nEngagements referencing missing customers:",
      (eng_cust["_merge"] == "left_only").sum())

# Engagements → Agents
eng_agent = engagements.merge(
    agents[["agentid"]],
    on="agentid",
    how="left",
    indicator=True
)
print("Engagements referencing missing agents:",
      (eng_agent["_merge"] == "left_only").sum())

# Engagements → Entertainers
eng_ent = engagements.merge(
    entertainers[["entertainerid"]],
    on="entertainerid",
    how="left",
    indicator=True
)
print("Engagements referencing missing entertainers:",
      (eng_ent["_merge"] == "left_only").sum())

# Entertainer_Members → Entertainers
em_ent = entertainer_members.merge(
    entertainers[["entertainerid"]],
    on="entertainerid",
    how="left",
    indicator=True
)
print("Entertainer_Members with missing entertainers:",
      (em_ent["_merge"] == "left_only").sum())

# Entertainer_Members → Members
em_mbr = entertainer_members.merge(
    members[["memberid"]],
    on="memberid",
    how="left",
    indicator=True
)
print("Entertainer_Members with missing members:",
      (em_mbr["_merge"] == "left_only").sum())

# Entertainer_Styles → Entertainers
es_ent = entertainer_styles.merge(
    entertainers[["entertainerid"]],
    on="entertainerid",
    how="left",
    indicator=True
)
print("Entertainer_Styles with missing entertainers:",
      (es_ent["_merge"] == "left_only").sum())

# Entertainer_Styles → Musical_Styles
es_style = entertainer_styles.merge(
    musical_styles[["styleid"]],
    on="styleid",
    how="left",
    indicator=True
)
print("Entertainer_Styles with missing styles:",
      (es_style["_merge"] == "left_only").sum())



# ---------- 6. Create cleaned versions for analysis ----------

# Here we do *light* cleaning: we don't modify raw data,
# but we define cleaned DataFrames that exclude obviously bad records.

# ---------- 6. Create cleaned versions for analysis (use lowercase column names) ----------

clean_agents = agents.copy()
# drop unrealistic salaries if you decide they are errors (e.g., < 1000)
clean_agents = clean_agents[clean_agents["salary"] >= 1000]

clean_engagements = engagements.copy()
# drop non-positive prices
clean_engagements = clean_engagements[clean_engagements["contractprice"] > 0]

clean_entertainer_styles = entertainer_styles.copy()
clean_entertainer_styles = clean_entertainer_styles[
    (clean_entertainer_styles["stylestrength"] >= 1)
    & (clean_entertainer_styles["stylestrength"] <= 10)
]

clean_musical_preferences = musical_preferences.copy()
clean_musical_preferences = clean_musical_preferences[
    clean_musical_preferences["preferenceseq"] > 0
]

clean_customers = customers.copy()
clean_customers["custphonenumber"] = clean_customers["custphonenumber"].fillna("Unknown")

clean_tables = {
    "agents": clean_agents,
    "customers": clean_customers,
    "entertainers": entertainers,           # unchanged
    "members": members,                     # unchanged
    "engagements": clean_engagements,
    "entertainer_styles": clean_entertainer_styles,
    "entertainer_members": entertainer_members,
    "musical_styles": musical_styles,
    "musical_preferences": clean_musical_preferences,
}

print("\n=== Cleaning finished. Cleaned tables ready for EDA. ===")
for name, df in clean_tables.items():
    print(f"{name}: {df.shape[0]} rows")

